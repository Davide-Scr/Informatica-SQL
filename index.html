<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SQLTARUNE — Impara SQL come se stessi giocando a Deltarune!</title>
  <style>
    :root{
      --bg:#0b0b0f; --panel:#111318; --accent:#ff6fb0; --muted:#9aa0a6; --good:#66bb6a; --bad:#e74c3c;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family: 'VT323', 'Segoe UI', Roboto, monospace;color:#e6eef8}
    body{background:radial-gradient(ellipse at 20% 10%, #13131a 0%, #08070a 40%),var(--bg);display:flex;align-items:center;justify-content:center;padding:24px}

    .container{width:100%;max-width:980px;background:linear-gradient(180deg,#121217 0%, #0e0f14 100%);border:3px solid rgba(255,111,176,0.12);border-radius:14px;padding:18px;display:grid;grid-template-columns:1fr 360px;gap:18px}

    header{grid-column:1/-1;display:flex;justify-content:space-between;align-items:center;padding:6px 12px}
    h1{margin:0;font-size:28px;color:var(--accent);text-shadow:0 0 10px rgba(255,111,176,0.18)}
  .subtitle{color:var(--muted);font-size:13px}
  .audio-toggle{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);padding:6px 10px;border-radius:8px;cursor:pointer}
  input[type=range]{width:110px;height:6px;background:transparent}
  input[type=range]::-webkit-slider-runnable-track{height:6px;background:linear-gradient(90deg,#555,#222);border-radius:6px}
  input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:12px;height:12px;border-radius:50%;background:var(--accent);margin-top:-3px}

    /* Arena */
    .arena{background:#0b0b10;border:2px solid rgba(255,255,255,0.03);border-radius:8px;padding:12px;position:relative;overflow:hidden;height:520px;display:flex;flex-direction:column}
    .arena .top-bar{display:flex;justify-content:space-between;align-items:center;padding:6px 8px;color:var(--muted);font-size:13px}
    .arena-canvas{position:relative;flex:1;border-radius:6px;background:linear-gradient(180deg,#0b0b10,#08080a);margin-top:8px}

    /* Player heart (red heart shape) */
    .soul{
      width:18px;height:18px;position:absolute;left:calc(50% - 9px);top:calc(50% - 9px);transform:rotate(-45deg);
      background:#ff3b3b;border-radius:4px;box-shadow:0 0 10px rgb(255, 59, 59);
    }
    .soul::before, .soul::after{
      content:'';position:absolute;width:18px;height:18px;border-radius:50%;background:#ff3b3b;}
    .soul::before{top:-9px;left:0}
    .soul::after{left:9px;top:0}

  /* Attacks (white) */
  .attack{position:absolute;background:linear-gradient(90deg,#ffffff,#f2f2f2);opacity:0.98;border-radius:4px;border:1px solid rgba(255,255,255,0.85);box-shadow:0 0 6px rgba(255,255,255,0.06)}

    /* Sidebar */
    .sidebar{background:var(--panel);border-radius:8px;padding:12px;display:flex;flex-direction:column;gap:12px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03)}
    .question{font-size:14px;color:#f5f8ff;min-height:72px}
    .options{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px}
  button.option{background:linear-gradient(90deg,#14150f,#131418);border:1px solid rgba(255,255,255,0.03);color:#e6eef8;padding:10px;border-radius:8px;cursor:pointer;font-size:13px;box-shadow:inset 0 -2px 0 rgba(0,0,0,0.35)}
  button.option:hover{border-color:var(--accent);transform:translateY(-3px)}
    button.option.correct{background:linear-gradient(90deg,#2e7d32,#66bb6a);border-color:rgba(102,187,106,0.8)}
  button.option.wrong{background:linear-gradient(90deg,#b71c1c,#e74c3c);border-color:rgba(231,76,60,0.8)}

  /* Start / Retry button styles */
  #startBtn, #retryBtn{background:var(--accent);color:#0b0b0b;border:none;padding:10px 16px;border-radius:10px;font-weight:700;cursor:pointer}
  #startBtn:hover, #retryBtn:hover{filter:brightness(1.08)}

    .hud{display:flex;gap:8px;align-items:center;color:var(--bad)}
  .health{flex:1;height:18px;background:rgba(255,255,255,0.04);border-radius:10px;padding:3px;border:1px solid rgba(255,255,255,0.03);display:flex;align-items:center}
  .health > i{display:block;height:12px;background:linear-gradient(90deg,#ff3b6e,#ff6fb0);width:100%;border-radius:8px;transition:width 300ms linear;box-shadow:0 0 8px rgba(255,111,176,0.12)}
    .badges{display:flex;flex-wrap:wrap;gap:6px}
    .badge{background:var(--accent);color:#0b0b10;padding:6px 8px;border-radius:999px;font-size:12px;font-weight:700}
  .hp-text{font-weight:700;color:#f5f8ff}
  .hp-hearts{margin-top:6px;display:flex;gap:4px}
  .hp-hearts span{color:#ff3b3b;font-size:14px;filter:drop-shadow(0 0 6px rgba(255,59,59,0.14))}

    /* Intro / Final overlay */
    .overlay{position:absolute;inset:0;background:linear-gradient(180deg,rgba(3,3,6,0.7),rgba(3,3,6,0.9));display:flex;flex-direction:column;align-items:center;justify-content:center;padding:18px;border-radius:8px}
    .overlay h2{color:var(--accent);margin:6px 0}
    .muted{color:var(--muted);font-size:13px}

    footer{grid-column:1/-1;text-align:center;color:var(--muted);font-size:12px;padding-top:6px}

    @media(max-width:900px){.container{grid-template-columns:1fr}.sidebar{order:2}.arena{order:1;height:420px}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>SQLTARUNE</h1>
        <div class="subtitle">Impara SQL evitando i colpi del virus NULL</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <div class="subtitle">Usa frecce/WASD per muovere il cuore • Scegli la risposta giusta</div>
        <button id="audioToggle" class="audio-toggle" title="Play / Pause musica">♪</button>
        <div style="display:flex;align-items:center;gap:6px;">
          <input id="volSlider" type="range" min="0" max="1" step="0.01" value="0.55" aria-label="Volume" />
        </div>
      </div>
    </header>

    <section class="arena card" id="arena">
      <div class="top-bar">
        <div id="levelLabel">Livello 1</div>
        <div class="hud">
          <div style="width:110px;text-align:right;color:var(--muted);font-size:13px;margin-right:8px">Player</div>
          <div class="health" title="Salute"><i id="hpFill" style="width:100%"></i></div>
        </div>
      </div>

      <div class="arena-canvas" id="arenaCanvas">
        <div class="soul" id="soul"></div>
        <!-- attacks are appended here -->
        <div id="overlayIntro" class="overlay">
          <h2>Benvenuto nel Regno dei Dati ✨</h2>
          <p class="muted">Il virus <strong>NULL</strong> ha corrotto il Database. Impara DDL, DML, DCL e TCL per ripristinare l'ordine.</p>
          <div style="height:12px"></div>
          <button id="startBtn">Inizia l'avventura</button>
        </div>
        <div id="overlayFinal" class="overlay" style="display:none">
          <h2 id="finalTitle">🎉 HAI SALVATO IL DATABASE!</h2>
          <div class="muted" id="finalText">Sei un Maestro SQL</div>
          <div style="height:10px"></div>
          <div id="finalBadges" class="badges"></div>
          <div style="height:12px"></div>
          <button id="retryBtn">Rigioca</button>
        </div>
        <audio id="bgAudio" preload="auto">
          <source src="Rude Buster.mp3" type="audio/mp4">wwdddddd
          <!-- Se il file non è disponibile, il browser ignorerà la traccia -->
        </audio>
      </div>
    </section>

    <aside class="sidebar">
      <div class="card">
        <div class="question" id="question">Premi Inizia per cominciare.</div>
        <div class="options" id="options"></div>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="muted">Badge</div>
          <div class="muted">Livello <span id="levelNum">1</span>/<span id="levelMax">4</span></div>
        </div>
        <div class="badges" id="badges"></div>
        <div style="margin-top:8px">
          <div class="hp-text">Salute: <span id="hpText">100</span>/<span id="hpMax">100</span></div>
          <div class="hp-hearts" id="hpHearts" aria-hidden="true"></div>
        </div>
      </div>

      <div class="card muted" style="font-size:13px">Seleziona rapidamente — le forze del virus non aspettano! Risposte sbagliate danneggiano il tuo cuore.</div>
    </aside>

    <footer>Questo è un gioco didattico — riprende lo stile bullet-hell per rendere l'apprendimento più divertente.</footer>
  </div>

  <script>
    const levels = [
      {question: "Il Database ha perso la tabella 'eroi'. Come la ricrei?", options:[
        {t:"INSERT INTO eroi VALUES ('Tu','Coraggioso');",ok:false},
        {t:"CREATE TABLE eroi (nome VARCHAR(50), titolo VARCHAR(50));",ok:true},
        {t:"SELECT * FROM eroi;",ok:false},
        {t:"DROP TABLE eroi;",ok:false}
      ],badge:'DDL Maestro'},
      {question: "Il tuo nome è scomparso dalla tabella 'eroi'. Come lo reinserisci?", options:[
        {t:"UPDATE eroi SET nome='Tu' WHERE titolo='Coraggioso';",ok:false},
        {t:"INSERT INTO eroi (nome,titolo) VALUES ('Tu','Coraggioso');",ok:true},
        {t:"DROP TABLE eroi;",ok:false},
        {t:"ALTER TABLE eroi ADD nome;",ok:false}
      ],badge:'DML Eroe'},
      {question: "Vuoi permettere ad 'Apprendista' di leggere la tabella 'eroi'. Cosa fai?", options:[
        {t:"GRANT SELECT ON eroi TO Apprendista;",ok:true},
        {t:"ALLOW Apprendista TO READ eroi;",ok:false},
        {t:"PERMIT Apprendista SELECT eroi;",ok:false},
        {t:"GRANT ALL ON eroi TO Apprendista;",ok:false}
      ],badge:'DCL Custode'},
      {question: "Hai fatto un errore nell'aggiornamento. Come torni indietro?", options:[
        {t:"UNDO LAST;",ok:false},
        {t:"ROLLBACK;",ok:true},
        {t:"CANCEL TRANSACTION;",ok:false},
        {t:"SAVEPOINT;",ok:false}
      ],badge:'TCL Mago'}
    ];

    // Game state
    let current = 0;
    const badges = [];
    let hp = 100; const maxHp = 100;
    let attacks = []; // {id,el,x,y,w,h,vx,vy}
    let running = false;

    // DOM
    const arena = document.getElementById('arenaCanvas');
    const soul = document.getElementById('soul');
    const hpFill = document.getElementById('hpFill');
    const questionEl = document.getElementById('question');
    const optionsEl = document.getElementById('options');
    const badgesEl = document.getElementById('badges');
    const overlayIntro = document.getElementById('overlayIntro');
    const overlayFinal = document.getElementById('overlayFinal');
    const startBtn = document.getElementById('startBtn');
    const retryBtn = document.getElementById('retryBtn');
    const levelLabel = document.getElementById('levelLabel');
    const levelNum = document.getElementById('levelNum');
    const levelMax = document.getElementById('levelMax');
    const finalBadges = document.getElementById('finalBadges');
  const hpText = document.getElementById('hpText');
  const hpMaxText = document.getElementById('hpMax');
  const hpHearts = document.getElementById('hpHearts');

    levelMax.innerText = levels.length;

    // runtime copy of levels (shuffled each play)
    let gameLevels = [];

    function shuffleArray(a){
      for(let i = a.length - 1; i > 0; i--){
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

  // Soul movement
  const state = {x:0,y:0,spd:2,keys:{},w:18,h:18};

    function resetSoulPos(){
      const rect = arena.getBoundingClientRect();
      state.x = (rect.width/2) - state.w/2;
      state.y = (rect.height/2) - state.h/2;
      updateSoulDom();
    }

    function updateSoulDom(){
      soul.style.left = state.x + 'px';
      soul.style.top = state.y + 'px';
    }

    window.addEventListener('resize', ()=>{resetSoulPos();});

    window.addEventListener('keydown', e=>{state.keys[e.key.toLowerCase()]=true});
    window.addEventListener('keyup', e=>{state.keys[e.key.toLowerCase()]=false});

    function spawnAttack(){
      const rect = arena.getBoundingClientRect();
      // spawn from random edge toward random target near center
      const side = Math.floor(Math.random()*4);
      let x,y,vx,vy,w=10+Math.random()*18,h=10+Math.random()*18,speed=1.2+Math.random()*2.2;
      if(side===0){ x = Math.random()*rect.width; y = -30; }
      if(side===1){ x = rect.width+30; y = Math.random()*rect.height; }
      if(side===2){ x = Math.random()*rect.width; y = rect.height+30; }
      if(side===3){ x = -30; y = Math.random()*rect.height; }
      const targetX = rect.width/2 + (Math.random()-0.5)*120;
      const targetY = rect.height/2 + (Math.random()-0.5)*120;
      const dx = targetX - x, dy = targetY - y, d = Math.hypot(dx,dy) || 1;
      vx = (dx/d)*speed; vy = (dy/d)*speed;

      const el = document.createElement('div');
      el.className = 'attack'; el.style.width = w+'px'; el.style.height = h+'px';
      el.style.left = x+'px'; el.style.top = y+'px';
      arena.appendChild(el);
      const a = {id:Date.now()+Math.random(),el,x,y,w,h,vx,vy};
      attacks.push(a);
    }

    let spawnTimer = 0;
    let spawnInterval = 900; // ms

    function gameTick(delta){
      if(!running) return;
      // move soul
      let dx=0,dy=0; if(state.keys['arrowup']||state.keys['w']) dy -= state.spd; if(state.keys['arrowdown']||state.keys['s']) dy += state.spd; if(state.keys['arrowleft']||state.keys['a']) dx -= state.spd; if(state.keys['arrowright']||state.keys['d']) dx += state.spd;
      const rect = arena.getBoundingClientRect();
      state.x = Math.max(0,Math.min(rect.width - state.w, state.x + dx));
      state.y = Math.max(0,Math.min(rect.height - state.h, state.y + dy));
      updateSoulDom();

      // spawn
      spawnTimer += delta;
      const levelSpeedFactor = 1 + (current*0.18);
      if(spawnTimer > spawnInterval/levelSpeedFactor){ spawnTimer = 0; spawnAttack();
        // occasionally spawn one extra attack for extra challenge
        if(Math.random() < 0.45 + current*0.05) spawnAttack();
      }

      // move attacks
      for(let i=attacks.length-1;i>=0;i--){
        const a = attacks[i]; a.x += a.vx*delta*0.06; a.y += a.vy*delta*0.06; 
        a.el.style.left = a.x+'px'; a.el.style.top = a.y+'px';
        // remove if outside
        if(a.x < -80 || a.x > rect.width+80 || a.y < -80 || a.y > rect.height+80){ a.el.remove(); attacks.splice(i,1); continue; }
        // collision
        if(collides(a, state)){
          // damage and remove
          damage(12 + Math.floor(current*6));
          a.el.remove(); attacks.splice(i,1);
        }
      }
    }

    function collides(a, s){
      const ax1 = a.x, ay1 = a.y, ax2 = a.x + a.w, ay2 = a.y + a.h;
      const sx1 = s.x, sy1 = s.y, sx2 = s.x + s.w, sy2 = s.y + s.h;
      return !(ax2 < sx1 || ax1 > sx2 || ay2 < sy1 || ay1 > sy2);
    }

    function damage(amount){
      hp = Math.max(0, hp - amount); updateHp();
      // flash effect
      soul.style.filter = 'hue-rotate(-20deg) saturate(1.4)';
      setTimeout(()=>soul.style.filter = '', 220);
      if(hp <= 0) gameOver();
    }

    function updateHp(){ 
      hpFill.style.width = (hp/maxHp*100)+'%'; 
      if(hpText) hpText.innerText = hp;
      if(hpMaxText) hpMaxText.innerText = maxHp;
      if(hpHearts){
        hpHearts.innerHTML = '';
        const hearts = 5; // show 5 heart icons representing health
        const portion = hp / maxHp; // 0..1
        for(let i=0;i<hearts;i++){
          const heartPortion = (i+1)/hearts; // threshold for full heart
          let icon = '🖤';
          if(portion >= heartPortion) icon = '❤️';
          else if(portion > (i/hearts)) icon = '💔';
          const span = document.createElement('span');
          span.innerText = icon;
          hpHearts.appendChild(span);
        }
      }
    }

    let lastTs = 0;
    function loop(ts){
      if(!lastTs) lastTs = ts; const delta = ts - lastTs; lastTs = ts; gameTick(delta); requestAnimationFrame(loop);
    }

    // UI
    function loadLevel(i){
      current = i; levelNum.innerText = (i+1); levelLabel.innerText = 'Livello '+(i+1);
      const lvl = (gameLevels && gameLevels[i]) ? gameLevels[i] : levels[i];
      questionEl.innerText = lvl.question;
      optionsEl.innerHTML = '';
      lvl.options.forEach((opt,idx)=>{
        const btn = document.createElement('button'); btn.className='option'; btn.innerText = opt.t; btn.onclick = ()=>selectOption(opt,btn);
        optionsEl.appendChild(btn);
      });
      // slightly increase difficulty
      spawnInterval = Math.max(500, 900 - i*140);
    }

    function selectOption(opt,btn){
      // disable quickly
      Array.from(optionsEl.children).forEach(b=>b.disabled=true);
      if(opt.ok){
        btn.classList.add('correct'); badges.push(levels[current].badge); renderBadges();
        // clear attacks gently
        attacks.forEach(a=>a.el.remove()); attacks = [];
        setTimeout(()=>{
          if(current+1 >= levels.length) finishGame(); else loadLevel(current+1);
        },900);
      } else {
        btn.classList.add('wrong'); damage(22);
        setTimeout(()=>{
          // re-enable buttons if still alive
          if(hp>0) Array.from(optionsEl.children).forEach(b=>b.disabled=false);
        },700);
      }
    }

    function renderBadges(){ badgesEl.innerHTML = ''; badges.forEach(b=>{const s=document.createElement('div');s.className='badge';s.innerText=b;badgesEl.appendChild(s)}); }

    function finishGame(){ running=false; overlayFinal.style.display='flex'; finalBadges.innerHTML=''; badges.forEach(b=>{const s=document.createElement('div');s.className='badge';s.innerText=b;finalBadges.appendChild(s)}); }

      function gameOver(){ 
        running=false; 
        overlayFinal.style.display='flex'; 
        document.getElementById('finalTitle').innerText='💀 GAME OVER'; 
        document.getElementById('finalText').innerText='Il tuo cuore si è fermato. Riprova per salvare il database.'; 
        finalBadges.innerHTML=''; 
        try{ if(bgAudio && !bgAudio.paused){ bgAudio.pause(); audioToggle && (audioToggle.innerText='♪'); } }catch(e){}
      }

    // Buttons
    const bgAudio = document.getElementById('bgAudio');
    const audioToggle = document.getElementById('audioToggle');

    // Volume slider wiring
    const volSlider = document.getElementById('volSlider');
    const storedVol = Number(localStorage.getItem('sqltale_volume'));
    if(!isNaN(storedVol) && volSlider){ volSlider.value = storedVol; }

    // Try to play audio when starting the game (user-initiated)
    startBtn.onclick = ()=>{
      overlayIntro.style.display='none';
      // prepare a shuffled runtime copy of levels so options change each run
      gameLevels = levels.map(l => ({ question: l.question, options: shuffleArray(l.options.map(o=>({t:o.t, ok:o.ok}))), badge: l.badge }));
      running=true; resetSoulPos(); hp = maxHp; updateHp(); loadLevel(0); requestAnimationFrame(loop);
      if(bgAudio){
        bgAudio.loop = true;
        bgAudio.volume = (volSlider ? Number(volSlider.value) : 0.55);
        bgAudio.play().then(()=>{
          audioToggle.innerText = '⏸';
        }).catch(()=>{
          // autoplay blocked or file missing — leave control to user
          audioToggle.innerText = '♪';
        });
      }
    };

    // adjust volume live
    volSlider && volSlider.addEventListener('input', (e)=>{
      const v = Number(e.target.value);
      if(bgAudio) bgAudio.volume = v;
      localStorage.setItem('sqltale_volume', String(v));
    });

    // Toggle audio play/pause
    audioToggle && audioToggle.addEventListener('click', ()=>{
      if(!bgAudio) return;
      if(bgAudio.paused){
        bgAudio.play().then(()=>{ audioToggle.innerText = '⏸'; }).catch(()=>{ audioToggle.innerText = '♪'; });
      } else { bgAudio.pause(); audioToggle.innerText = '♪'; }
    });

    retryBtn && (retryBtn.onclick = ()=>{ location.reload(); });

    // initial setup
    resetSoulPos(); updateHp();
  </script>
</body>
</html>